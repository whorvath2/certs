# certs
This is a library of zsh shell scripts for generating TLS certificates as needed based on a trusted intermediate CA.

## Requirements

  * These scripts are written for use in a [zsh](https://zsh.sourceforge.io/Guide/zshguide.html) shell session.
  * You must have [OpenSSL](https://www.openssl.org) v3+ installed.
  * You must have [podman](https://podman.io) v4+ installed.
  * These scripts do not include a mechanism for creating a root CA, nor the intermediate CA that's commonly used to sign certificate signing requests (CSRs) while keeping the root CA securely offline. [Here are robust instructions for creating a root + intermediate bundle.](https://www.golinuxcloud.com/openssl-create-certificate-chain-linux/)
  * Access to the bundle from these scripts is via environment variables, which should be set as follows:

    * CERTS_DIR - The directory in which public certificates created by these scripts will be published.
    * PRIVATE_KEY_DIR - The directory in which secret keys for public certificates created by these scripts are stored.
    * REVOKED_CERTS_DIR - The directory in which revoked certificates are recorded.
    * OPENSSL_CONF_PATH - The path to the primary openssl configuration file used when managing certificates.
    * OPENSSL_EXT_PATH - The path to an X.509 extensions configuration file. 
    * OPENSSL_PASSIN_PATH - The path to an encrypted password file that can be used in automating authentication for some openssl calls.
    * ROOT_CA_PATH - The path to a copy of the public certificate of the root CA used to generate the intermediate CA to be used for signing CSRs generated by these scripts.
    * INTERMEDIATE_CA_BUNDLE_PATH -The path to the file containing the public certificates of both the root CA and the intermediate CA that is to be used for signing CSRs generated by these scripts.
    * INTERMEDIATE_CA_KEY_PATH - The path to the secret key for the intermediate CA certificate to be used for signing CSRs generated by these scripts.
    * The following environment variables are for convenience in desgnating the [subject (Distinguished Names)](https://stackoverflow.com/a/61691431/470477) of certificates generated by these scripts: 
      * COUNTRY
      * STATE 
      * LOCALE 
      * ORGANIZATION 
      * ORGANIZATIONAL_UNIT

## Usage

The create_cert.sh script is used to generate a host-specific certificate with zero or more subject alternative names:

    create_cert.sh (hostname) [subjAltNames...]

### Example:

    create_cert.sh example.com localhost

When created, the new certificate file will appear in the CERTS_DIR with a name that's derived from the hostname argument; e.g., `example.com.pem`.

### Podman secrets

One of the side effects of the `create_cert.sh` script is to create a collection of podman secrets that can be used in calling scripts:

  * ${HOST_NAME}_cert_key - Set to the value of $HOST_KEY_PATH (calculated and set from the hostname argument)
  * ${HOST_NAME}_cert_pub - Set to the value of $HOST_CERT_PATH (calculated and set from the hostname argument)
  * ${HOST_NAME}_cert_bundle_pub - Set to the value of $HOST_CERT_BUNDLE_PATH (calculated and set from the hostname argument)
  * intermediate_ca_bundle_pub - Set to the value of $INTERMEDIATE_CA_BUNDLE_PATH
  * root_ca_pub - Set to the value of $ROOT_CA_PATH
